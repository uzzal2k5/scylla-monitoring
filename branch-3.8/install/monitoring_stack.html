


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    Install Scylla Monitoring Stack | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server."/>

    <link rel="icon" href="../_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">
    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="../_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/tabs.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/v4-shims.css"/>
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/expertrec.js"></script>

    <script src="../_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>



<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="../_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylladb.github.io/scylla-monitoring/">Scylla Monitoring Stack</a>
                    </li>
                    
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">Scylla Cloud</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">

        

        <section id="install-scylla-monitoring-stack">
<h1>Install Scylla Monitoring Stack<a class="headerlink" href="#install-scylla-monitoring-stack" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#minimal-production-system-recommendations" id="id4">Minimal Production System Recommendations</a></p>
<ul>
<li><p><a class="reference internal" href="#calculating-prometheus-minimal-disk-space-requirement" id="id5">Calculating Prometheus Minimal Disk Space requirement</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#prerequisites" id="id6">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#docker-post-installation" id="id7">Docker Post Installation</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id8">Install Scylla Monitoring Stack</a></p></li>
<li><p><a class="reference internal" href="#configure-scylla-monitoring-stack" id="id9">Configure Scylla Monitoring Stack</a></p>
<ul>
<li><p><a class="reference internal" href="#configure-scylla-nodes-from-files" id="id10">Configure Scylla nodes from files</a></p></li>
<li><p><a class="reference internal" href="#configure-scylla-nodes-using-scylla-manager-consul-api" id="id11">Configure Scylla nodes using Scylla-Manager Consul API</a></p></li>
<li><p><a class="reference internal" href="#connecting-scylla-monitoring-to-scylla" id="id12">Connecting Scylla-Monitoring to Scylla</a></p></li>
<li><p><a class="reference internal" href="#use-an-external-directory-for-the-prometheus-data-directory" id="id13">Use an external directory for the Prometheus data directory</a></p></li>
<li><p><a class="reference internal" href="#add-additional-prometheus-targets" id="id14">Add Additional Prometheus Targets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#start-and-stop-scylla-monitoring-stack" id="id15">Start and Stop Scylla Monitoring Stack</a></p>
<ul>
<li><p><a class="reference internal" href="#start" id="id16">Start</a></p></li>
<li><p><a class="reference internal" href="#stop" id="id17">Stop</a></p></li>
<li><p><a class="reference internal" href="#start-a-specific-scylla-monitoring-stack-version" id="id18">Start a Specific Scylla Monitoring Stack Version</a></p></li>
<li><p><a class="reference internal" href="#accessing-the-localhost" id="id19">Accessing the <cite>localhost</cite></a></p></li>
<li><p><a class="reference internal" href="#configure-rsyslog-on-each-scylla-node" id="id20">Configure rsyslog on each Scylla node</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#view-grafana-dashboards" id="id21">View Grafana Dashboards</a></p></li>
</ul>
</div>
<p>This document describes the setup of Scylla Monitoring Stack, based on <a class="reference external" href="monitoring_apis#prometheus">Scylla Prometheus API</a>.</p>
<p>The Scylla Monitoring Stack needs to be installed on a dedicated server, external to the Scylla cluster. Make sure the Scylla Monitoring Stack server has access to the Scylla nodes so that it can pull the metrics over the Prometheus API.</p>
<p>For evaluation, you can run Scylla Monitoring Stack on any server (or laptop) that can handle three Docker instances at the same time. For production, see recommendations below.</p>
<section id="minimal-production-system-recommendations">
<h2><a class="toc-backref" href="#id4">Minimal Production System Recommendations</a><a class="headerlink" href="#minimal-production-system-recommendations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>CPU</strong> - at least 2 physical cores/ 4vCPUs</p></li>
<li><p><strong>Memory</strong> - 15GB+ DRAM</p></li>
<li><p><strong>Disk</strong> - persistent disk storage is proportional to the number of cores and Prometheus retention period (see the following section)</p></li>
<li><p><strong>Network</strong> - 1GbE/10GbE preferred</p></li>
</ul>
<section id="calculating-prometheus-minimal-disk-space-requirement">
<h3><a class="toc-backref" href="#id5">Calculating Prometheus Minimal Disk Space requirement</a><a class="headerlink" href="#calculating-prometheus-minimal-disk-space-requirement" title="Permalink to this headline">¶</a></h3>
<p>Prometheus storage disk performance requirements: persistent block volume, for example an EC2 EBS volume</p>
<p>Prometheus storage disk volume requirement:  proportional to the number of metrics it holds. The default retention period is 15 days, and the disk requirement is around 200MB per core, assuming the default scraping interval of 15s.</p>
<p>For example, when monitoring a 6 node Scylla cluster, each with 16 CPU cores, and using the default 15 days retention time, you will need <strong>minimal</strong> disk space of</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">6</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">200</span><span class="n">MB</span> <span class="o">~</span> <span class="mi">20</span><span class="n">GB</span>
</pre></div>
</div>
<p>To account for unexpected events, like replacing or adding nodes, we recommend allocating at least x4-5 space, in this case, ~100GB.
Prometheus Storage disk does not have to be as fast as Scylla disk, and EC2 EBS, for example, is fast enough and provides HA out of the box.</p>
</section>
</section>
<section id="prerequisites">
<h2><a class="toc-backref" href="#id6">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Follow the Installation Guide and install <a class="reference external" href="https://docs.docker.com/install/">docker</a> on the Scylla Monitoring Stack Server. This server can be the same server that is running Scylla Manager. Alternatively, you can <a class="reference external" href="monitor_without_docker">Deploy Scylla Monitoring Stack Without Docker</a> .</p></li>
<li><p>If you have Prometheus or Grafana installed, confirm that your version is supported by the Scylla Monitoring Stack version you want to install. Refer to the table below.</p></li>
</ul>
<table class="colwidths-given docutils align-default" id="id3">
<caption><span class="caption-text">Scylla Monitoring Stack Compatibility Matrix</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Scylla Monitoring Stack Version</p></th>
<th class="head"><p>Prometheus Version</p></th>
<th class="head"><p>Grafana Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>3.8</p></td>
<td><p>2.27.1</p></td>
<td><p>7.5.7</p></td>
</tr>
<tr class="row-odd"><td><p>3.7</p></td>
<td><p>2.25.2</p></td>
<td><p>7.4.0</p></td>
</tr>
<tr class="row-even"><td><p>3.6</p></td>
<td><p>2.18.1</p></td>
<td><p>7.3.5</p></td>
</tr>
<tr class="row-odd"><td><p>3.5</p></td>
<td><p>2.18.1</p></td>
<td><p>7.1.5</p></td>
</tr>
<tr class="row-even"><td><p>3.4</p></td>
<td><p>2.18.1</p></td>
<td><p>6.7.3</p></td>
</tr>
</tbody>
</table>
</section>
<section id="docker-post-installation">
<h2><a class="toc-backref" href="#id7">Docker Post Installation</a><a class="headerlink" href="#docker-post-installation" title="Permalink to this headline">¶</a></h2>
<p>Docker post installation guide can be found <a class="reference external" href="https://docs.docker.com/install/linux/linux-postinstall/">here</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Avoid running the container as root.</p>
</div>
<p>To avoid running docker as root, you should add the user you are going to use for Scylla Monitoring Stack to the Docker group.</p>
<ol class="arabic simple">
<li><p>Create the Docker group.</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo groupadd docker
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Add your user to the docker group. Log out and log in again. The new group will be active for this user on next login.</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Start Docker by calling:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo systemctl <span class="nb">enable</span> docker
</pre></div>
</div>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id8">Install Scylla Monitoring Stack</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure</strong></p>
<ol class="arabic simple">
<li><p>Download and extract the latest <a class="reference external" href="https://github.com/scylladb/scylla-monitoring/releases">Scylla Monitoring Stack binary</a>;.</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>wget https://github.com/scylladb/scylla-monitoring/archive/scylla-monitoring-3.8.2.tar.gz
tar -xvf scylla-monitoring-3.8.2.tar.gz
<span class="nb">cd</span> scylla-monitoring-scylla-monitoring-3.8.2
</pre></div>
</div>
<p>As an alternative, you can clone and use the Git repository directly.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/scylladb/scylla-monitoring.git
<span class="nb">cd</span> scylla-monitoring
git checkout branch-3.8
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start Docker service if needed</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart docker
</pre></div>
</div>
</section>
<section id="configure-scylla-monitoring-stack">
<h2><a class="toc-backref" href="#id9">Configure Scylla Monitoring Stack</a><a class="headerlink" href="#configure-scylla-monitoring-stack" title="Permalink to this headline">¶</a></h2>
<p>To monitor the cluster, Scylla Monitoring Stack (Specifically the Prometheus Server) needs to know the IP of all the nodes and the IP of the Scylla Manager Server (if you are using Scylla Manager).</p>
<p>This configuration can be done from files, or using the <a class="reference external" href="https://www.consul.io/">Consul</a> api.</p>
<p>Scylla Manager 2.0 and higher supports the Consul API.</p>
<section id="configure-scylla-nodes-from-files">
<h3><a class="toc-backref" href="#id10">Configure Scylla nodes from files</a><a class="headerlink" href="#configure-scylla-nodes-from-files" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">prometheus/scylla_servers.yml</span></code> with the targets’ IPs (the servers you wish to monitor).</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important that the name listed in <code class="docutils literal notranslate"><span class="pre">dc</span></code> in the <code class="docutils literal notranslate"><span class="pre">labels</span></code> matches the datacenter names used by Scylla.
Use the <code class="docutils literal notranslate"><span class="pre">nodetool</span> <span class="pre">status</span></code> command to validate the datacenter names used by Scylla.</p>
</div>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">172.17.0.2</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">172.17.0.3</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">cluster</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster1</span>
      <span class="l l-Scalar l-Scalar-Plain">dc</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dc1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to add your managed cluster to Scylla Monitoring Stack, add the IPs of the nodes as well as the cluster name you used when you <a class="reference external" href="https://manager.docs.scylladb.com/stable/add-a-cluster.html">added the cluster</a> to Scylla Manager. It is important that the label <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">name</span></code> and the cluster name in Scylla Manager match.</p>
</div>
<p><em>Using IPV6</em></p>
<p>To use IPv6 inside scylla_server.yml, add the IPv6 addresses with their square brackets and the port numbers.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;[2600:1f18:26b1:3a00:fac8:118e:9199:67b9]:9180&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;[2600:1f18:26b1:3a00:fac8:118e:9199:67ba]:9180&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">cluster</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster1</span>
      <span class="l l-Scalar l-Scalar-Plain">dc</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dc1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For IPv6 to work, both scylla Prometheus address and node_exporter’s <cite>–web.listen-address</cite> should be set to listen to an IPv6 address.</p>
</div>
<p>For general node information (disk, network, etc.) Scylla Monitoring Stack uses the <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code> agent that runs on the same machine as Scylla does.
By default, Prometheus will assume you have a <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code> running on each machine. If this is not the case, for example if Scylla runs in a container and the node_exporter runs on the host, you can override the <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code>
targets configuration file by creating an additional file and passing it with the <code class="docutils literal notranslate"><span class="pre">-n</span></code> flag.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, there is no need to create <code class="docutils literal notranslate"><span class="pre">node_exporter_server.yml</span></code>. Prometheus will use the same targets it uses for
Scylla and will assume you have a <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code> running on each Scylla server.</p>
</div>
<p>If needed, you can set your own target file instead of the default <code class="docutils literal notranslate"><span class="pre">prometheus/scylla_servers.yml</span></code>, using the <code class="docutils literal notranslate"><span class="pre">-s</span></code> for Scylla target files.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./start-all.sh -s my_scylla_server.yml -d prometheus_data</span>
</pre></div>
</div>
<p>Mark the different Data Centers with Labels.</p>
<p>As can be seen in the examples, each target has its own set of labels to mark the cluster name and the data center (dc).
You can add multiple targets in the same file for multiple clusters or multiple data centers.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">genconfig.py</span></code> script to generate the server file. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./genconfig.py -d myconf -dc dc1:192.168.0.1,192.168.0.2 -dc dc2:192.168.0.3,192.168.0.4</span>
</pre></div>
</div>
<p>This will generate a server file for four servers in two datacenters server <code class="docutils literal notranslate"><span class="pre">192.168.0.1</span></code> and <code class="docutils literal notranslate"><span class="pre">192.168.0.2</span></code> in dc1 and <code class="docutils literal notranslate"><span class="pre">192.168.0.3</span></code> and <code class="docutils literal notranslate"><span class="pre">192.168.0.4</span></code> in dc2.</p>
<p>OR</p>
<p>The <code class="docutils literal notranslate"><span class="pre">genconfig.py</span></code> script can also use <code class="docutils literal notranslate"><span class="pre">nodetool</span> <span class="pre">status</span></code> to generate the server file using the <code class="docutils literal notranslate"><span class="pre">-NS</span></code> flag.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">nodetool status | ./genconfig.py -NS</span>
</pre></div>
</div>
<p>2. Connect to <a class="reference external" href="https://scylladb.github.io/scylla-manager/">Scylla Manager</a> by creating <code class="docutils literal notranslate"><span class="pre">prometheus/scylla_manager_servers.yml</span></code>
If you are using Scylla Manager, you should set its IP and port in this file.</p>
<p>You must add a scylla_manager_servers.yml file even if you are not using the manager.
You can look at: <code class="docutils literal notranslate"><span class="pre">prometheus/scylla_manager_servers.example.yml</span></code> for an example.</p>
<p>For example if <cite>Scylla Manager</cite> host IP is <cite>172.17.0.7</cite> <code class="docutils literal notranslate"><span class="pre">prometheus/scylla_manager_servers.yml</span></code> would look like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># List Scylla Manager end points</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">172.17.0.7:5090</span>
</pre></div>
</div>
<p>Note that you do not need to add labels to the Scylla Manager targets.</p>
</section>
<section id="configure-scylla-nodes-using-scylla-manager-consul-api">
<h3><a class="toc-backref" href="#id11">Configure Scylla nodes using Scylla-Manager Consul API</a><a class="headerlink" href="#configure-scylla-nodes-using-scylla-manager-consul-api" title="Permalink to this headline">¶</a></h3>
<p>Scylla Manager 2.0 has a <a class="reference external" href="https://www.consul.io/">Consul</a> like API.</p>
<p>When using the manager as the configuration source, there is no need  to set any of the files.
Instead you should set the scylla-manager IP from the command line using the <cite>-L</cite> flag.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./start-all.sh -L 10.10.0.1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are running Scylla-Manager on the same host as Scylla-Monitoring you should use -l flag so that the localhost address
will be available from within the container.</p>
</div>
</section>
<section id="connecting-scylla-monitoring-to-scylla">
<h3><a class="toc-backref" href="#id12">Connecting Scylla-Monitoring to Scylla</a><a class="headerlink" href="#connecting-scylla-monitoring-to-scylla" title="Permalink to this headline">¶</a></h3>
<p>Scylla-Manager version 3.5 and higher can read tables from a Scylla node using CQL. If your Scylla cluster is user/password protected (See <a class="reference external" href="https://docs.scylladb.com/operating-scylla/security/enable-authorization/">Scylla  Authorization</a>) you should assign a user and password for the Scylla-Grafana connection.</p>
<p>You can limit the user to read only, currently it only read table from the system keyspace.</p>
<p>To set a user/password edit <cite>grafana/provisioning/datasources/datasource.yaml</cite>.</p>
<p>Under <strong>scylla-datasource</strong> Uncomment the <strong>secureJsonData</strong> part and set the user and password.</p>
</section>
<section id="use-an-external-directory-for-the-prometheus-data-directory">
<h3><a class="toc-backref" href="#id13">Use an external directory for the Prometheus data directory</a><a class="headerlink" href="#use-an-external-directory-for-the-prometheus-data-directory" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">-d</span></code> flag, places the Prometheus data directory outside of its container and by doing that makes it persistent.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Specifying an external directory is important for systems in production. Without it,
every restart of the monitoring stack will result in metrics lost.</p>
</div>
<p>If the directory provided does not exist, the <code class="docutils literal notranslate"><span class="pre">start-all.sh</span></code> script will create it. Note that you should avoid running docker as root, the <code class="docutils literal notranslate"><span class="pre">start-all.sh</span></code> script
will use the user permissions that runs it. This is important if you want to place the prometheus directory not under the user path but somewhere else, for example <code class="docutils literal notranslate"><span class="pre">/prometheus-data</span></code>.</p>
<p>In that case, you need to create the directory before calling <code class="docutils literal notranslate"><span class="pre">start-all.sh</span></code> and make sure it has the right permissions for the user running the command.</p>
</section>
<section id="add-additional-prometheus-targets">
<h3><a class="toc-backref" href="#id14">Add Additional Prometheus Targets</a><a class="headerlink" href="#add-additional-prometheus-targets" title="Permalink to this headline">¶</a></h3>
<p>There are situations where you would like to monitor additional targets using the Prometheus server of the monitoring stack.
For example, an agent that runs on a firewall server.
The Prometheus server reads its targets from a file, this file is generated from a template when calling <code class="docutils literal notranslate"><span class="pre">start-all.sh</span></code>.
To add your targets you would need to edit the template file before calling <code class="docutils literal notranslate"><span class="pre">start-all.sh</span></code>.</p>
<p>The template file is either <code class="docutils literal notranslate"><span class="pre">prometheus/prometheus.yml.template</span></code> if Prometheus reads the Scylla target from file, or <code class="docutils literal notranslate"><span class="pre">prometheus/prometheus.consul.yml.template</span></code>
if Prometheus gets Scylla targets from the manager Consul API.</p>
<p>You can add a target at the end of the file, for example, the following example would read from a server with IP address 17.0.0.1 with a Prometheus port of 7000.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">job_name</span><span class="p p-Indicator">:</span> <span class="s">&#39;myservice&#39;</span>
  <span class="c1"># Override the global default and scrape targets from this job every 5 seconds.</span>
  <span class="l l-Scalar l-Scalar-Plain">scrape_interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5s</span>
  <span class="l l-Scalar l-Scalar-Plain">static_configs</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">17.0.0.1:7000</span>
</pre></div>
</div>
</section>
</section>
<section id="start-and-stop-scylla-monitoring-stack">
<h2><a class="toc-backref" href="#id15">Start and Stop Scylla Monitoring Stack</a><a class="headerlink" href="#start-and-stop-scylla-monitoring-stack" title="Permalink to this headline">¶</a></h2>
<section id="start">
<h3><a class="toc-backref" href="#id16">Start</a><a class="headerlink" href="#start" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./start-all.sh -d prometheus_data</span>
</pre></div>
</div>
</section>
<section id="stop">
<h3><a class="toc-backref" href="#id17">Stop</a><a class="headerlink" href="#stop" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./kill-all.sh</span>
</pre></div>
</div>
</section>
<section id="start-a-specific-scylla-monitoring-stack-version">
<h3><a class="toc-backref" href="#id18">Start a Specific Scylla Monitoring Stack Version</a><a class="headerlink" href="#start-a-specific-scylla-monitoring-stack-version" title="Permalink to this headline">¶</a></h3>
<p>By default, start-all.sh will start with dashboards for the latest Scylla Open source version and the latest Scylla Manager version.</p>
<p>You can specify specific scylla version with the <code class="docutils literal notranslate"><span class="pre">-v</span></code> flag and Scylla Manager version with <code class="docutils literal notranslate"><span class="pre">-M</span></code> flag.</p>
<p>Multiple versions are supported. For example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./start-all.sh -v <span class="m">2020</span>.1,2019.1 -M <span class="m">2</span>.1 -d prometheus-data
</pre></div>
</div>
<p>will load the dashboards for Scylla Enterprise versions <code class="docutils literal notranslate"><span class="pre">2020.1</span></code> and <code class="docutils literal notranslate"><span class="pre">2019.1</span></code> and the dashboard for Scylla Manager <code class="docutils literal notranslate"><span class="pre">2.1</span></code></p>
</section>
<section id="accessing-the-localhost">
<h3><a class="toc-backref" href="#id19">Accessing the <cite>localhost</cite></a><a class="headerlink" href="#accessing-the-localhost" title="Permalink to this headline">¶</a></h3>
<p>The Prometheus server runs inside a Docker container if it needs to reach a target on the local- host: either Scylla or Scylla-Manager, it needs to use the host network and not the Docker network.
To do that run ./start-all.sh with the -l flag. For example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./start-all.sh -l -d prometheus-data
</pre></div>
</div>
</section>
<section id="configure-rsyslog-on-each-scylla-node">
<h3><a class="toc-backref" href="#id20">Configure rsyslog on each Scylla node</a><a class="headerlink" href="#configure-rsyslog-on-each-scylla-node" title="Permalink to this headline">¶</a></h3>
<p>generates metrics and alerts from logs. To get full functionality, you should use <a class="reference external" href="https://www.rsyslog.com/">rsyslog</a>. Scylla Monitoring Stack will act as an additional rsyslog server.
Scylla Monitoring Stack collects Scylla logs using Loki and generates metrics and alerts based on these logs.
To use this feature, you need to direct logs from each Scylla node to Loki.
The recommended method to do this is by using <a class="reference external" href="https://www.rsyslog.com/">rsyslog</a>, where Scylla Monitoring Stack (Loki) acts as an additional rsyslog server.
.. note:: Scylla can send logs to more than one log collection service.</p>
<p><strong>Prerequisite</strong>, make sure rsyslog is installed and running. If rsyslog is not installed, follow the installation <a class="reference external" href="https://www.rsyslog.com/doc/v8-stable/installation/index.html">instruction</a>.</p>
<p>Add scylla’s rsyslog configuration file. Add the file: <code class="docutils literal notranslate"><span class="pre">/etc/rsyslog.d/scylla.conf</span></code>.</p>
<p>If Scylla Monitoring Stack IP is 10.0.0.1, the file should look like</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nv">$programname</span> <span class="o">==</span>  <span class="s1">&#39;scylla&#39;</span> <span class="k">then</span> @@10.0.0.1:1514<span class="p">;</span>RSYSLOG_SyslogProtocol23Format
</pre></div>
</div>
<p>Restart rsyslog for the configuration to take effect.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl restart rsyslog
</pre></div>
</div>
</section>
</section>
<section id="view-grafana-dashboards">
<h2><a class="toc-backref" href="#id21">View Grafana Dashboards</a><a class="headerlink" href="#view-grafana-dashboards" title="Permalink to this headline">¶</a></h2>
<p>Point your browser to <code class="docutils literal notranslate"><span class="pre">your-server-ip:3000</span></code>
By default, Grafana authentication is disabled. To enable it and set a password for user admin use the <code class="docutils literal notranslate"><span class="pre">-a</span></code> option.</p>
</section>
</section>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../use-monitoring/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Download and Install</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="start_all.html">The start-all.sh script</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitor_without_docker.html">Deploy without Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker_compose.html">Docker Compose</a></li>
<li class="toctree-l2"><a class="reference internal" href="min-prod-hw.html">System Recommendations</a></li>
<li class="toctree-l2"><a class="reference internal" href="thanos.html">Using Thanos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../procedures/index.html">Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
                <div class="scylla-dropdown ">
    <a href="#" data-options="align:bottom" data-dropdown="drop-versions" class="scylla-dropdown__button">
        
            3.8
        
        <i class="fa fa-caret-down" aria-hidden="true"></i>
    </a>
    <ul id="drop-versions" class="f-dropdown scylla-dropdown__content" data-dropdown-content>
            
              <li><a href="../../branch-3.9/install/monitoring_stack.html">3.9</a></li>
            
            
              <li><a href="monitoring_stack.html">3.8</a></li>
            
            
              <li><a href="../../branch-3.7/install/monitoring_stack.html">3.7</a></li>
            
            
              <li><a href="../../branch-3.6/index.html">3.6</a></li>
            
            
              <li><a href="../../branch-3.5/index.html">3.5</a></li>
            
            
    </ul>
</div>
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="../_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
          <div class="scylla-dropdown">
    <a href="#" data-options="align:top" data-dropdown="drop-contribute" class="scylla-dropdown__button">
        Contribute 
        <i class="fa fa-github" aria-hidden="true"></i>
        <i class="fa fa-caret-down" aria-hidden="true"></i>
    </a>
    <ul id="drop-contribute" class="f-dropdown scylla-dropdown__content" data-dropdown-content>
        <li><a href="https://github.com/scylladb/scylla-monitoring/issues/new?title=Issue in page Install Scylla Monitoring Stack&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://monitoring.docs.scylladb.com/branch-3.8/install/monitoring_stack%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">Report a doc issue <i class="fa fa-external-link" aria-hidden="true"></i></a></li>
        <li><a href="https://docs.scylladb.com/contribute/" target="_blank">Learn how to contribute <i class="fa fa-external-link" aria-hidden="true"></i></a></li>
    </ul>
</div>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2021, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 11 September 2021.
            </div>
            <div class="footer-version">
                Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
                &amp; <a href="https://sphinx-theme.scylladb.com">ScyllaDB Theme 0.1.25</a>
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="../_static/js/vendor/jquery.js"></script>
<script src="../_static/js/vendor/jquery.cookie.min.js"></script>
<script src="../_static/expertrec.js"></script>
<script src="../_static/js/foundation/foundation.js"></script>
<script src="../_static/js/foundation/foundation.topbar.js"></script>
<script src="../_static/js/foundation/foundation.dropdown.js"></script>
<script src="../_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>